#!/bin/sh

echo "Running pre-commit checks..."

# 0. Verify lockfile is in sync (catches CI failures early)
echo "Verifying lockfile..."
bun install --frozen-lockfile
if [ $? -ne 0 ]; then
  echo "Lockfile out of sync. Run 'bun install' and commit the updated bun.lockb"
  exit 1
fi

# 1. Lint
echo "Running ESLint..."
bun run lint
if [ $? -ne 0 ]; then
  echo "Lint failed"
  exit 1
fi

# 2. Check formatting
echo "Checking formatting..."
bunx prettier --check .
if [ $? -ne 0 ]; then
  echo "Formatting check failed"
  exit 1
fi

# 3. Build all packages
echo "Running build..."
bun run build
if [ $? -ne 0 ]; then
  echo "Build failed"
  exit 1
fi

# 4. TypeScript type checking
echo "Running typecheck..."
bun run typecheck
if [ $? -ne 0 ]; then
  echo "Typecheck failed"
  exit 1
fi

# 5. Run unit tests
echo "Running package unit tests..."
bunx turbo run test --filter='./packages/*' --concurrency=4
if [ $? -ne 0 ]; then
  echo "Package unit tests failed"
  exit 1
fi

# 6. Run CLI unit tests
echo "Running CLI unit tests..."
cd apps/cli && bun run test
if [ $? -ne 0 ]; then
  echo "CLI unit tests failed"
  exit 1
fi
cd ../..  # Return to root

echo "All pre-commit checks passed!"
